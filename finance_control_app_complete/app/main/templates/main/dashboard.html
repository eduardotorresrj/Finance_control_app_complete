{% extends 'base.html' %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h2 class="text-white">ðŸ“Š Dashboard</h2>
  <a class="btn btn-success" href="/transaction/add">
    <i class="bi bi-plus-circle"></i> Nova TransaÃ§Ã£o
  </a>
</div>

<!-- Cards Stats Customizados -->
<div class="row mb-4">
  <div class="col-md-4 mb-3">
    <div class="stat-card success fade-in">
      <div class="stat-label">ðŸ’° Total Receitas</div>
      <div class="stat-value">
        R$ {% if total_income is defined %}{{ "{:,.2f}".format(total_income) }}{% else %}0,00{% endif %}
      </div>
    </div>
  </div>

  <div class="col-md-4 mb-3">
    <div class="stat-card danger fade-in">
      <div class="stat-label">ðŸ’¸ Total Despesas</div>
      <div class="stat-value">
        R$ {% if total_expenses is defined %}{{ "{:,.2f}".format(total_expenses) }}{% else %}0,00{% endif %}
      </div>
    </div>
  </div>

  <div class="col-md-4 mb-3">
    <div class="stat-card info fade-in">
      <div class="stat-label">ðŸ’µ Saldo Atual</div>
      <div class="stat-value {% if ((total_income|default(0)) - (total_expenses|default(0))) >= 0 %}text-success{% else %}text-danger{% endif %}">
        R$ {% if total_income is defined and total_expenses is defined %}
          {{ "{:,.2f}".format(total_income - total_expenses) }}
        {% else %}0,00{% endif %}
      </div>
      <div class="text-muted small">Receitas - Despesas</div>
    </div>
  </div>
</div>

<!-- Chart -->
<div class="chart-container fade-in" style="overflow-x:auto; width: 100%">
  <h4 class="mb-3">ðŸ“ˆ Receitas vs Despesas - Este MÃªs</h4>
  <p class="text-muted small mb-3">Cada barra representa uma transaÃ§Ã£o individual</p>
  <canvas id="chart"></canvas>
</div>

<!-- Recent Transactions -->
<div class="card fade-in">
  <div class="card-header">
    <h4 class="mb-0"><i class="bi bi-clock-history"></i> TransaÃ§Ãµes Recentes</h4>
  </div>
  <div class="card-body">
    {% if transactions is defined and transactions %}
    <div class="table-responsive">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>Data</th>
            <th>Tipo</th>
            <th>Categoria</th>
            <th>DescriÃ§Ã£o</th>
            <th class="text-end">Valor</th>
            <th class="text-center">AÃ§Ãµes</th>
          </tr>
        </thead>
        <tbody>
          {% for t in transactions %}
          <tr>
            <td>{{ t.date.strftime('%d/%m/%Y') if t.date else '-' }}</td>
            <td>
              {% if t.type == 'income' %}
                <span class="badge badge-income">Receita</span>
              {% else %}
                <span class="badge badge-expense">Despesa</span>
              {% endif %}
            </td>
            <td><strong>{{ t.category or '-' }}</strong></td>
            <td>
              <strong>{{ t.description or '-' }}</strong>
              {% if t.payment_method %}
                <br>
                <small class="text-muted">
                  {% if t.payment_method == 'dinheiro' %}
                    <span class="badge bg-success">ðŸ’µ Dinheiro</span>
                  {% elif t.payment_method == 'debito' %}
                    <span class="badge bg-info">ðŸ’³ DÃ©bito</span>
                  {% elif t.payment_method == 'credito' %}
                    <span class="badge bg-primary">ðŸ’³ CrÃ©dito</span>
                  {% elif t.payment_method == 'pix' %}
                    <span class="badge bg-secondary">ðŸ“± PIX</span>
                  {% endif %}
                </small>
              {% endif %}
            </td>
            <td class="text-end">
              <strong class="{% if t.type == 'income' %}text-success{% else %}text-danger{% endif %}">
                {% if t.type == 'income' %}+{% else %}-{% endif %}
                R$ {{ "{:,.2f}".format(t.amount) if t.amount else '0,00' }}
              </strong>
            </td>
            <td class="text-center">
              <div class="action-buttons">
                <a href="/transaction/edit/{{ t.id }}" class="btn btn-sm btn-info" title="Editar">
                  <i class="bi bi-pencil"></i>
                </a>
                <a href="/transaction/delete/{{ t.id }}" class="btn btn-sm btn-danger" title="Excluir" onclick="return confirm('Tem certeza que deseja excluir esta transaÃ§Ã£o?')">
                  <i class="bi bi-trash"></i>
                </a>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="empty-state">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
      </svg>
      <h5>Nenhuma transaÃ§Ã£o encontrada</h5>
      <p class="text-muted">Comece adicionando sua primeira transaÃ§Ã£o!</p>
      <a href="/transaction/add" class="btn btn-primary mt-3">
        <i class="bi bi-plus-circle"></i> Adicionar TransaÃ§Ã£o
      </a>
    </div>
    {% endif %}
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    {% if labels is defined and incomes is defined and expenses is defined %}
    const labels = {{ labels | safe }};
    const incomes = {{ incomes | safe }};
    const expenses = {{ expenses | safe }};

    const canvas = document.getElementById('chart');
    if (!canvas) {
      console.error('Canvas nÃ£o encontrado');
      return;
    }

    const ctx = canvas.getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [
          {
            label: 'Receitas',
            data: incomes,
            backgroundColor: 'rgba(16, 185, 129, 0.8)',
            borderColor: 'rgba(16, 185, 129, 1)',
            borderWidth: 2,
            borderRadius: 8
          },
          {
            label: 'Despesas',
            data: expenses,
            backgroundColor: 'rgba(239, 68, 68, 0.8)',
            borderColor: 'rgba(239, 68, 68, 1)',
            borderWidth: 2,
            borderRadius: 8
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        aspectRatio: 2,
        plugins: {
          legend: {
            position: 'top',
            labels: {
              font: {size: 14, weight: 'bold'}
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                return context.dataset.label + ': R$ ' + context.parsed.y.toFixed(2).replace('.', ',');
              }
            }
          }
        },
        scales: {
          x: {
            ticks: {
              maxRotation: 60,
              minRotation: 45,
              font: { size: 9, weight: 'bold' },
              autoSkip: false,
            },
            grid: { display: false },
          },
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return 'R$ ' + value.toFixed(2).replace('.', ',');
              }
            }
          }
        }
      }
    });
    {% else %}
    console.warn('Dados do grÃ¡fico nÃ£o disponÃ­veis');
    {% endif %}
  });
</script>
{% endblock %}